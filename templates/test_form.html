<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Test Form</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dragula/3.7.2/dragula.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dragula/3.7.2/dragula.min.css" />
</head>

<body>
    <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasExample" aria-labelledby="offcanvasExampleLabel"
        style="z-index: 2000;">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="offcanvasExampleLabel">Menu</h5>
            <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <div>
                <a class="btn btn-primary open-modal-button">Add Job</a>
            </div>
        </div>
    </div>
    <!-- Navbar -->
    <nav class="navbar navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('test_toc', smo=smo) }}">Test form</a>
            <span class="navbar-text">
                Job Number: {{ job_info.SMO }} | Client: {{ job_info['Client Name'] }} | Standard: {{ job_info.Standard }}
            </span>
            <button class="btn btn-outline-success" type="button" data-bs-toggle="offcanvas"
                data-bs-target="#offcanvasExample" aria-controls="offcanvasExample">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">

            <!-- LEFT PANEL GOES HERE -->
            <div class="col-md-2">
                <div class="card mt-2" style="position: fixed; width: 16%;">
                    <div class="card-body">
                        <div class="card-header">
                            <h5>Files</h5>
                        </div>
                        <ul class="list-group list-group-flush" style="margin-top: 10px; margin-left: 10px;">
                            {% for file in files %}
                            <li draggable="true" id="{{file}}" class="draggable">
                                <a href="/{{smo}}/{{test_data["Number"]}}/download/{{file}}" download
                                    data-img-src="/{{smo}}/{{test}}/download/{{file}}" class="file-link">{{ file }}</a>
                            </li>
                            {% endfor %}
                            <div id="image-preview" style="display: none; position: fixed;">
                                <img id="preview-img" src="" alt="Image preview"
                                    style="max-width:300px; max-height:300px;">
                            </div>
                        </ul>
                        <div style="margin-top: 20px;">
                            <form action="/upload" method="post" enctype="multipart/form-data">
                                <input type="hidden" name="smo" value="{{ smo }}">
                                <input type="hidden" name="test" value="{{ test }}">
                                <input type="hidden" name="next" value="{{ request.url }}">
                                <div class="input-group">
                                    <input type="file" class="form-control" name="file" id="file-input">
                                    <button type="submit" class="btn btn-primary">Upload</button>
                                </div>
                            </form>
                        </div>


                    </div>
                </div>
            </div>

            <!-- Main Form -->
            <div class="col-md-8">
                <!-- Your main form HTML here -->

                <div class="container">
                    <h1 class="mb-4">{{ test_data["Number"] }} - {{ test_data["Requirement"]  }}</h1>
                    <form id="test-form" action="{{ url_for('test_form_submission', smo=smo, test=test_data["Number"]) }}" method="post">

                        <fieldset class="mb-3">
                            <legend>Requirements</legend>
                            <div class="mb-3">
                                <label>
                                    <test_data class="method">{{ test_data["Requirement"] }}
                                </label>
                            </div>
                        </fieldset>

                        <div class="mb-3">
                            <label for="Operator" class="form-label">Operator</label>
                            <input type="text" class="form-control" id="Operator" name="Operator"
                                value='{{ test_data["Operator"] }}'>
                        </div>
                        <fieldset class="mb-3">
                            <legend>Method</legend>
                            <div class="mb-3">
                                <label>
                                    <test_data class="method">{{ test_data.Methodology }}
                                </label>
                            </div>
                            <div class="mb-3">
                                <label for="method-comment" class="form-label">Method Comment</label>
                                <textarea class="form-control" id="method-comment" name="method-comment"
                                    rows="3">{{ test_data['method-comment'] }}</textarea>
                            </div>
                        </fieldset>
                        <fieldset class="mb-3">
                            <legend>Criteria</legend>
                            <div class="mb-3">
                                <label>
                                    <test_data class="method">{{ test_data['Test Criteria'] }}
                                </label>
                            </div>
                            <div class="mb-3">
                                <label for="criteria-comment" class="form-label">Criteria Comment</label>
                                <textarea class="form-control" id="criteria-comment" name="criteria-comment"
                                    rows="3">{{ test_data['criteria-comment'] }}</textarea>
                            </div>
                            <div class="mb-3">
                                <label for="status" class="form-label">Status</label>
                                <select class="form-select" name="status">
                                    <option value="not started" {% if test_data['Status'].lower() == 'Nan' %}selected{% endif %}>
                                    </option>
                                    <option value="not started" {% if test_data['Status']=='not started' %}selected{% endif
                                        %}>
                                    </option>
                                    <option value="High" {% if test_data['Status']=='High' %}selected{% endif %}>High
                                    </option>
                                    <option value="medium" {% if test_data['Status']=='medium' %}selected{% endif %}>Medium
                                    </option>
                                    <option value="low" {% if test_data['Status']=='low' %}selected{% endif %}>Low</option>
                                    <option value="passed" {% if test_data['Status']=='passed' %}selected{% endif %}>Passed
                                    </option>
                                    <option value="N/A" {% if test_data['Status']=='N/A' %}selected{% endif %}>N/A</option>
                                </select>
                            </div>
                        </fieldset>
                        <div class="mb-3">
                            <label for="conclusion" class="form-label">Conclusion</label>
                            <select class="form-select" name="conclusion" onchange="">
                                <option value="" {% if test_data.conclusion=='' %}selected{% endif %}></option>
                                <option value="Passed" {% if test_data.conclusion=='Passed' %}selected{% endif %}>Passed
                                </option>
                                <option value="Failed" {% if test_data.conclusion=='Failed' %}selected{% endif %}>Failed
                                </option>
                                <option value="Not Applicable" {% if test_data.conclusion=='Not Applicable' %}selected{%
                                    endif %}>N/A
                                </option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="date" class="form-label">Date</label>
                            <input type="date" class="form-control" id="date" name="date" value="{{ test_data['Date of Test'] }}"
                                required>
                        </div>

                        <!-- Add more form elements for other test data fields -->

                        <button type="button" id="submit-btn" class="btn btn-primary">Submit</button>
                    
                    </form>
                </div>
            </div>

            <div class="col-md-2">
                <div class="card mt-2" style="position: fixed; width: 15%;">
                    <div class="card-body">
                        <div class="card-header">
                            <h5>QR</h5>
                        </div>
                        <div style="margin-top: 20px; justify-self: stretch; width: fit-content;">
                            <div id="qrcode"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

    <!-- Code for the QR -->
    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
    <script src="{{ url_for('static', filename='qrcode_generator.js') }}"></script>
    <script>
        var This_page_url = "{{ request.url }}";
    </script>

    <script src="{{ url_for('static', filename='left_panel.js') }}"></script>


    <script>
        document.getElementById("submit-btn").addEventListener("click", function () {
            var form = document.getElementById("test-form");
            var formData = new FormData(form);
    
            var jsonData = {};
            formData.forEach(function (value, key) {
                jsonData[key] = value;
            });
    
            var xhr = new XMLHttpRequest();
            xhr.open("POST", form.action, true);
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    // Handle successful form submission
                    window.location.reload(); // Reload the page or perform any other action
                }
            };
            xhr.send(JSON.stringify(jsonData));
        });
    </script>

</body>

</html>